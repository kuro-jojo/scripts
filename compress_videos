#!/usr/bin/env bash

# --- Input validation ---
if [ -z "$1" ]; then
    echo "Error: No directory provided."
    exit 1
fi

INPUT_DIR="$1"

if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: '$INPUT_DIR' is not a valid directory."
    exit 1
fi

LOGFILE="${INPUT_DIR}/compression_failures.log"
> "$LOGFILE"

# Collect files sorted by size, excluding:
#   - *.log
#   - *_compressed.*
mapfile -t files < <(
    find "$INPUT_DIR" -maxdepth 1 -type f \
        ! -name "*.log" \
        ! -name "*_compressed.*" \
        -printf "%s %p\n" \
    | sort -n \
    | awk '{ $1=""; sub(/^ /, ""); print }'
)

for infile in "${files[@]}"; do
    [ -f "$infile" ] || continue

    filename=$(basename -- "$infile")
    name="${filename%.*}"
    ext="${filename##*.}"

    outfile="${INPUT_DIR}/${name}_compressed.${ext}"

    ffmpeg -y -i "$infile" -vcodec libx265 -preset faster -crf 28 "$outfile"
    if [ $? -ne 0 ]; then
        echo "$filename" >> "$LOGFILE"
    fi
done

if [ -s "$LOGFILE" ]; then
    echo "Failures recorded in $LOGFILE"
else
    echo "All files processed successfully."
fi
